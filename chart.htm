<!doctype html>
<html lang="en">
<head>
<script>
const debugip="192.168.0.177";  //change this to the esp32 ip for remote running of this page
</script>
<meta charset="utf-8">
<meta name="viewport" content="minimal-ui,width=device-width,initial-scale=1.0,user-scalable=no" />
<link rel="icon" href="data:;base64,iVBORw0KGgo="><!--prevent favicon requests-->
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<!--<script src="https://code.jquery.com/jquery-3.4.1.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>-->
<title>smartMeterLogger Overzicht</title>
<meta name="description" content="smartMeterLogger-esp32">
<meta name="author" content="Cellie">
<script>!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.ReconnectingWebSocket=b()}(this,function(){function a(b,c,d){function l(a,b){var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,!1,!1,b),c}var e={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};d||(d={});for(var f in e)this[f]="undefined"!=typeof d[f]?d[f]:e[f];this.url=b,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var h,g=this,i=!1,j=!1,k=document.createElement("div");k.addEventListener("open",function(a){g.onopen(a)}),k.addEventListener("close",function(a){g.onclose(a)}),k.addEventListener("connecting",function(a){g.onconnecting(a)}),k.addEventListener("message",function(a){g.onmessage(a)}),k.addEventListener("error",function(a){g.onerror(a)}),this.addEventListener=k.addEventListener.bind(k),this.removeEventListener=k.removeEventListener.bind(k),this.dispatchEvent=k.dispatchEvent.bind(k),this.open=function(b){h=new WebSocket(g.url,c||[]),b||k.dispatchEvent(l("connecting")),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",g.url);var d=h,e=setTimeout(function(){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",g.url),j=!0,d.close(),j=!1},g.timeoutInterval);h.onopen=function(){clearTimeout(e),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onopen",g.url),g.protocol=h.protocol,g.readyState=WebSocket.OPEN,g.reconnectAttempts=0;var d=l("open");d.isReconnect=b,b=!1,k.dispatchEvent(d)},h.onclose=function(c){if(clearTimeout(e),h=null,i)g.readyState=WebSocket.CLOSED,k.dispatchEvent(l("close"));else{g.readyState=WebSocket.CONNECTING;var d=l("connecting");d.code=c.code,d.reason=c.reason,d.wasClean=c.wasClean,k.dispatchEvent(d),b||j||((g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onclose",g.url),k.dispatchEvent(l("close")));var e=g.reconnectInterval*Math.pow(g.reconnectDecay,g.reconnectAttempts);setTimeout(function(){g.reconnectAttempts++,g.open(!0)},e>g.maxReconnectInterval?g.maxReconnectInterval:e)}},h.onmessage=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",g.url,b.data);var c=l("message");c.data=b.data,k.dispatchEvent(c)},h.onerror=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onerror",g.url,b),k.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(b){if(h)return(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","send",g.url,b),h.send(b);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(a,b){"undefined"==typeof a&&(a=1e3),i=!0,h&&h.close(a,b)},this.refresh=function(){h&&h.close()}}return a.prototype.onopen=function(){},a.prototype.onclose=function(){},a.prototype.onconnecting=function(){},a.prototype.onmessage=function(){},a.prototype.onerror=function(){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a});</script>
<style>
*{box-sizing:border-box;}
html,body{
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  right:0;
  margin:0;
  padding:0;
  background:black;
  color:#f1f1f1;
  text-align:center;
  font-family:'Roboto',sans-serif;
  overflow:hidden;
}
.noselect{
  -webkit-touch-callout:none; /* iOS Safari */
    -webkit-user-select:none; /* Safari */
     -khtml-user-select:none; /* Konqueror HTML */
       -moz-user-select:none; /* Firefox */
        -ms-user-select:none; /* Internet Explorer/Edge */
            user-select:none; /* Non-prefixed version,currently
                                  supported by Chrome and Opera */
}
#graphContainer{
  width:1440px;
  height:500px;
  margin:20px auto;
  border:solid 1px antiquewhite;
}
#myChart{
  width:100%;
  height:100%;
}
</style>
</head>
<body class="noselect">
<div id="graphContainer">
<canvas id="background" width="1440" height="500"></canvas>
<canvas id="myChart" width="1440" height="500"></canvas>
</div>
<script>
var url="http://";
if (window.location.hostname)url+=window.location.hostname;
else url+=debugip;
var ws_host="ws://";
if(window.location.hostname)ws_host+=window.location.hostname+"/current";
else ws_host+=debugip+"/current";

const maxrange=1000;//in w

var canvasbg = document.getElementById('myChart');
const ctxbg = canvasbg.getContext('2d');

var canvas = document.getElementById('myChart');
const ctx = canvas.getContext('2d');

const canvasheight=canvas.height;

// https://codetonics.com/javascript/detect-document-ready/
function ready(callbackFunction){
  if(document.readyState != 'loading')
    callbackFunction(event)
  else
    document.addEventListener("DOMContentLoaded", callbackFunction)
}

ready(event => {
  //console.log('DOM is ready.');
  includeHTML("http://192.168.0.107/2020/12/2.log", includeHTML_callBack);
})

function map(x,in_min,in_max,out_min,out_max){
  return (x-in_min)*(out_max-out_min)/(in_max-in_min)+out_min;
}

// https://riptutorial.com/html5-canvas/example/13472/fillstyle--a-path-styling-attribute-

// http://zetcode.com/gfx/html5canvas/transparency/

// https://developer.ibm.com/technologies/web-development/tutorials/wa-canvashtml5layering/

// https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas

function includeHTML_callBack(result){
  //split the result in time and usage
  const data = result.split('\n');
  //draw a nice background
  //first a scale background (horizontal stripes)
  ctx.beginPath();
  ctx.textBaseline = "middle";
  ctx.globalAlpha = .27;
  ctx.strokeStyle='orange';
  ctx.textAlign = 'center';
  //ctx.setLineDash([12, 24,12,25])
  ctx.font = "30px Roboto";
  const step=canvasheight/10;
  for(vgrid=canvasheight;vgrid>0;vgrid-=step){
    ctx.moveTo(0,vgrid);
    ctx.lineTo(1440,vgrid);
    ctx.fillStyle = "red";
    const wattage=map(vgrid,canvasheight,0,0,maxrange).toString()+"W";
    ctx.fillText(wattage, 100, vgrid);
    ctx.fillText(wattage, 1440/2, vgrid);
    ctx.fillText(wattage, 1440-100, vgrid);
  }
  ctx.stroke();

  // draw the whole hours
  ctx.beginPath();
  ctx.strokeStyle='yellow';
  ctx.fillStyle = "yellow";
  ctx.setLineDash([12, 24,12,25])
  ctx.globalAlpha = .35;
  for(h=1;h<24;h++){
    const xpos=map(h,0,24,0,1440);
    ctx.beginPath();
    ctx.moveTo(xpos,0);
    ctx.lineTo(xpos,canvasheight);
    ctx.fillText(h, xpos, 50);
    ctx.fillText(h, xpos, canvasheight/2);
    ctx.fillText(h, xpos, canvasheight-50);
    ctx.stroke();
  }

  // draw the data
  ctx.beginPath();
  ctx.globalAlpha = 1;
  ctx.setLineDash([]);
  ctx.strokeStyle='green';
  data.forEach(function(item,index){
    if (item[0]!='#') {
      const itemdata=item.split(' ');
      const tm=new Date(itemdata[0]*1000);
      const aantal_seconden=tm.getSeconds()+tm.getMinutes()*60+tm.getHours()*3600;
      const xpos=map(aantal_seconden,0,86400,0,1440);
      ctx.moveTo(xpos,canvasheight);
      const ypos=map(itemdata[1],0,maxrange,canvasheight,0);
      ctx.lineTo(xpos,ypos);
      //console.log("Tijd:"+tm.getHours()+":"+tm.getMinutes()+":"+tm.getSeconds());
    }
    ctx.stroke();
  });
};

function includeHTML(link, callBack) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            callBack(this.responseText);
        }
      }
      xhttp.open("GET", link, true);
      xhttp.send();
      return;
}

</script>
</body>
</html>
